---
- name: create foodtrac system group
  group:
    name: foodtrac
    system: yes

- name: create foodtrac system user
  user:
    name: foodtrac
    group: foodtrac
    system: yes

- name: create foodtrac mysql database
  mysql_db:
    name: foodtrac_db
    state: present
#    TODO: fix credential setup, should not be committing password to repo

- name: create foodtrac mariadb database
  mysql_user:
    name: foodtrac
    password: '12345'
    priv: 'foodtrac_db.*:ALL'
    state: present

- name: Install git package
  apt:
    state: latest
    name: git

- name: checkout foodtrac code
  register: git_finished
  git:
    repo: 'https://github.com/hrla14-foodtrac/foodtrac.git'
    dest: /var/www/foodtrac

- name: install npm deps
  shell: npm install
  register: npm_finished
  failed_when: '"ERR!" in npm_finished.stderr'
  when: git_finished.changed
  args:
    chdir: /var/www/foodtrac

- name: install foodtrac environment variables
  tags: current
  copy:
    src: .env
    dest: /var/www/foodtrac/.env
    owner: foodtrac
    group: foodtrac

- name: install foodtrac systemd unit
  tags: current
  copy:
    src: foodtrac.service
    dest: /etc/systemd/system/foodtrac.service
    owner: root
    group: root
    mode: 0644

- name: start foodtrac systemd service
  tags: current
  systemd:
    state: started
    name: foodtrac
    daemon_reload: yes

- name: install foodtrac Nginx configuration
  tags: current
  notify:
  - reload nginx
  copy:
    src: foodtrac.me.nginx
    dest: /etc/nginx/sites-available/foodtrac.me
    owner: root
    group: root

- name: Enable Foodtrac Nginx configuration
  tags: current
  notify:
  - reload nginx
  file:
    src: /etc/nginx/sites-available/foodtrac.me
    dest: /etc/nginx/sites-enabled/foodtrac.me
    owner: root
    group: root
    state: link

- name: Ensure Nginx default site is disabled
  tags: current
  notify:
  - reload nginx
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
